
## 案件で使える動画配信の知識

及川 康祐

---

## 経緯

- 案件で動画関係に携わることがあった
- 社内で動画に詳しい人が少ないので共有する必要性を感じたので取り急ぎ

---

## 動画配信の種類

- mp4ファイルをhttpsで配信
  - mp4ファイルをhttpsで配信する。非ライブ配信で使われる。楽。


- ストリーミング配信
  - 色々種類が多すぎるので今回は割愛

今日はmp4ファイルをhttpsで配信することに関して話します

---

## mp4ファイルで配信するのは何が嬉しいか

---

- GCSにファイル配置してURL参照するだけ

- ブラウザで再生する場合videoタグでURL指定するだけ
  ```html
  <video src="https://domain/sample.mp4"></video>
  ```
- 署名付きURLを使用すればセキュリティ上の安全性も確保しやすい

- ただしライブ配信はできない

---

### ファイルダウンロードしきるまで再生できないのでは?🤔

---

### そんなこたーない

- 主要なブラウザはmp4ファイルをプログレッシブダウンロードすることができる。

***

### プログレッシブダウンロードとは?

- ストリーミングと同じようにデータをダウンロードしながら再生すること(疑似ストリーミング再生とも)

- プログレッシブダウンロードしやすいようにmp4の形式を変更してやる必要がある
  → ffmpegを使う

---

### プログレッシブダウンロードしやすい形式

mp4のメタデータであるmoov atomをmp4ファイルの先頭に配置してやる必要がある。おそらくmoov atom内に各動画セグメントのサイズ情報があると思われる。

***
***

### ffmepgについて

- 動画関係ならなんでもできる便利ツール
- よくアーミーナイフに例えられる
![アーミーナイフ](59756310-69ee9700-92c4-11e9-93ac-959fd9a74455.jpg)


---

なお実際は・・・

![アーミーナイフ2](02_px400.jpg)

---

(^q^)


***

### moov atomを先頭に配置する
以下のコマンドを実行する
```sh
$ ffmpeg -i input.mp4 -c copy -movflags +faststart output.mp4
```

---

プログレッシブダウンロードしても動画再生が重い時


まず画質が良すぎることを疑う
  - 解像度・ビットレートを下げることを検討する
	- 音質が良すぎないか確認


---

### 画質の変更の仕方
ffmpegで変換する
※解像度を640x480,動画のビットレートを768kbpsに変換する例
```sh
$ ffmpeg -i input.mp4 -s 640x480 -vb 768k output.mp4
```

---

### 画質の変更する際の注意

- 解像度は再生するUIに合わせる。
  - 例えば全画面表示で動画を再生しない場合、ある程度解像度下げてもいいかなとか・・・

- ビットレートは妥協できる範囲を手探りでさがす

- fpsは変更しない
  - いわゆる音ズレの訪れが発生する危険性がある

- 元動画ファイルを残しておく際、GCSの金額見積もりに注意する
  - 再生用と元動画ファイル２つGCS上に保存するため

---

### まとめ

- すでにファイルが存在する動画配信はプログレッシブダウンロードで配信するのが無難

- 無理にストリーミング配信にしようとしない

- 画質が良すぎないか確認する

- GCSの金額に気をつける
